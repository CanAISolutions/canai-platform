#!/bin/sh

# TaskMaster Git Integration Pre-commit Hook
# Validates commits against TaskMaster automation rules

set -e

echo "ğŸ”„ Running TaskMaster pre-commit validation..."

# Check if automation config exists
if [ ! -f ".taskmaster/config/automation.json" ]; then
  echo "âš ï¸ TaskMaster automation not configured. Run 'npm run taskmaster:setup'"
  exit 0
fi

# Get current branch name
BRANCH=$(git branch --show-current)

# Check if this is a TaskMaster automated branch
if echo "$BRANCH" | grep -q "^feature/task-"; then
  echo "âœ… TaskMaster automated branch detected: $BRANCH"

  # Extract task ID from branch name
  TASK_ID=$(echo "$BRANCH" | sed 's/feature\/task-\([0-9]*\).*/\1/')

  if [ -n "$TASK_ID" ]; then
    echo "âœ… Validated task ID: $TASK_ID"
  else
    echo "âš ï¸ Could not extract task ID from branch name"
  fi
else
  echo "â„¹ï¸ Non-TaskMaster branch, skipping automation validation"
fi

# Run standard pre-commit checks
echo "ğŸ”„ Running standard linting and formatting..."

# Run lint-staged for staged files
if command -v npx >/dev/null 2>&1; then
  npx lint-staged
else
  echo "âš ï¸ npx not found, skipping lint-staged"
fi

echo "âœ… Pre-commit validation complete!"

exit 0
